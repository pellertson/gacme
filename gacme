#!/usr/bin/env rc
# a gemini client written for acme

. $PLAN9/lib/acme.rc
fullResponse=`{mktemp}

# echo $response | winwrite body

fn die {
	rm $fullResponse
	exit 1
}

fn get {
	openssl s_client -crlf -quiet \
	                 -no_ssl3 -no_tls1 -no_tls1_1 \
	                 -connect $1:$2 -servername $1
}

fn parseResponse {
	awk -v `{printf 'hostname=%s' $1} \
	    -v `{printf 'path=%s' $2} \
	    -f /usr/local/lib/parseResponse.awk $fullResponse
}


newwindow
winname $1
echo $1 | get $2 1965 > $fullResponse
parseResponse $2 $3 | winwrite body

winctl 'clean'
printf '0,0' | winwrite addr
winctl 'dot=addr'
winctl 'show'

rm $fullResponse
