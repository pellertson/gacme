#!/usr/bin/env rc
# a gemini client written for acme

. $PLAN9/lib/acme.rc
fullResponse=`{mktemp}

fn get {
	cmd='openssl s_client -crlf -quiet -no_ssl3 -no_tls1 -no_tls1_1 -connect $1:$2 -servername $1'
	eval $cmd
}

fn parseResponse {
	head=`{sed 1q $fullResponse}
	code=$head(1)
	if (~ $"code 20) {
		type=`{echo $"head | ssam -n 'x/[a-z]+\/[a-z]+/p'}

		if (~ $type text/gemini) {
			tail +2l $fullResponse | awk -v `{printf 'hostname=%s' $1} \
			                             -v `{printf 'path=%s' $2} \
			                             -f /usr/local/lib/parseGeminiResponse.awk
		}
		if (~ $type 'text/plain') {
			tail +2l $fullResponse
		}
		if not {
			echo "You downloaded an unsupported filetype.  Sorry about that"
		}
	}
	if not {
		cat $fullResponse
	}
}


echo $1 | get $2 1965 > $fullResponse
newwindow
winname $1
parseResponse $2 $3 | winwrite body

winctl 'clean'
printf '0,0' | winwrite addr
winctl 'dot=addr'
winctl 'show'

rm $fullResponse
